# Technical Decisions

Quick reference for implementation decisions.

## Stack

| Component | Choice | Rationale |
|-----------|--------|-----------|
| Platform | Next.js 15 (App Router) | Modern React, SSR, API routes, great DX |
| Auth | Better Auth | Email + Google OAuth, session management |
| Database | SQLite + Drizzle ORM | Fast prototyping, easy migration to Postgres |
| Styling | Tailwind CSS + shadcn/ui | Rapid UI development, consistent design |
| QR Codes | qrcode library | Generate unique member QR codes |
| Deployment | Environment-managed | Handled by deployment environments |

## Key Libraries

| Library | Purpose |
|---------|---------|
| `next` | React framework with App Router |
| `better-auth` | Authentication (email + OAuth) |
| `drizzle-orm` | Type-safe ORM |
| `better-sqlite3` | SQLite driver |
| `tailwindcss` | Utility-first CSS |
| `@shadcn/ui` | Accessible component library |
| `qrcode` | QR code generation |
| `zod` | Schema validation |

## Architecture Notes

### Multi-Tenancy
- Every database query includes `organizationId` filter
- Middleware enforces organization context
- URLs don't expose tenant info (session-based)

### Authentication Flow
1. User signs up/logs in via Better Auth
2. Session includes organizationId (if set)
3. If no organization, redirect to onboarding
4. Onboarding creates org + first gym
5. Dashboard accessible after onboarding

### API Structure
```
/api/auth/[...all]     # Better Auth routes
/api/gyms              # Gym CRUD
/api/members           # Member CRUD
/api/qr/[memberId]     # QR code generation
```

### QR Code Format
```
{orgId}/{memberId}/{uniqueCode}
```
- Encodes organization context
- Unique per member
- Can be regenerated if needed

## Security Considerations

### Authentication
- Better Auth handles session management
- CSRF protection built-in
- Secure cookie settings

### Data Isolation
- Organization-scoped queries enforced
- Middleware validates access
- API routes verify ownership

### Input Validation
- Zod schemas for all inputs
- Server-side validation required
- Client validation for UX

## Database Schema

### organizations
```typescript
{
  id: text (uuid),
  name: text,
  slug: text (unique),
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### users
```typescript
{
  id: text (uuid),
  email: text (unique),
  name: text,
  organizationId: text (FK),
  role: text ('owner' | 'admin' | 'staff'),
  createdAt: timestamp
}
```

### gyms
```typescript
{
  id: text (uuid),
  organizationId: text (FK),
  name: text,
  address: text,
  phone: text,
  email: text,
  openingHours: json,
  facilities: json,
  isActive: boolean,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### members
```typescript
{
  id: text (uuid),
  organizationId: text (FK),
  gymId: text (FK),
  firstName: text,
  lastName: text,
  email: text,
  phone: text,
  emergencyContactName: text,
  emergencyContactPhone: text,
  qrCode: text (unique),
  membershipStart: date,
  membershipEnd: date,
  isActive: boolean,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

## Development Notes

### Getting Started
```bash
# Install dependencies
pnpm install

# Set up environment
cp .env.example .env

# Run migrations
pnpm db:push

# Start dev server
pnpm dev
```

### Environment Variables
```env
DATABASE_URL=file:./db.sqlite
BETTER_AUTH_SECRET=your-secret-here
BETTER_AUTH_URL=http://localhost:3000
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

*Generated by Squared Agent for the Gym Management System v1 prototype.*
